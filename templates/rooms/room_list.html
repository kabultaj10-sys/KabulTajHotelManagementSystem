{% extends 'base.html' %}

{% block title %}Rooms - Kabul Taj Hotel{% endblock %}

{% block content %}
<!-- Enhanced Header -->
<div class="hotel-header">
    <div class="header-main">
        <div class="header-content">
            <h1 class="header-title">Room Management</h1>
            <p class="header-subtitle">Manage room availability, status, and bookings</p>
        </div>

        <div class="header-actions">
            <a href="{% url 'room_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                <span>Add Room</span>
            </a>
            <a href="{% url 'booking_create' %}" class="btn btn-outline">
                <i class="fas fa-calendar-plus"></i>
                <span>New Booking</span>
            </a>
        </div>
    </div>

    <div class="nav-tabs-container">
        <div class="nav-tabs">
            <a href="{% url 'booking_list' %}" class="nav-tab">
                <svg class="icon" viewBox="0 0 24 24">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <span>Bookings</span>
            </a>
            
            <a href="{% url 'room_list' %}" class="nav-tab active">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M2 4v16"/>
                    <path d="M2 8h18a2 2 0 0 1 2 2v10"/>
                    <path d="M2 17h20"/>
                    <path d="M6 8v9"/>
                </svg>
                <span>Rooms</span>
            </a>
            
            <a href="{% url 'conference:conference_list' %}" class="nav-tab">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <span>Conferences</span>
            </a>
        </div>
    </div>
</div>

<!-- Room Status Overview -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon" style="background-color: var(--color-success); color: white;">
            <i class="fas fa-bed"></i>
        </div>
        <div class="stat-number">{{ stats.available }}</div>
        <div class="stat-label">Available Rooms</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background-color: var(--color-danger); color: white;">
            <i class="fas fa-user-check"></i>
        </div>
        <div class="stat-number">{{ stats.occupied }}</div>
        <div class="stat-label">Occupied Rooms</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background-color: var(--color-warning); color: white;">
            <i class="fas fa-tools"></i>
        </div>
        <div class="stat-number">{{ stats.maintenance }}</div>
        <div class="stat-label">Maintenance</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background-color: var(--color-gold); color: var(--color-gold-foreground);">
            <i class="fas fa-building"></i>
        </div>
        <div class="stat-number">{{ stats.total }}</div>
        <div class="stat-label">Total Rooms</div>
    </div>
</div>

<!-- Search and Filters -->
<div class="card">
    <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
        <h3 style="font-size: 1.25rem; font-weight: var(--font-weight-semibold); color: var(--color-foreground);">
            Search & Filters
        </h3>
        
        <form method="get" style="display: flex; flex-wrap: wrap; gap: var(--spacing-md); align-items: center;">
            <div style="position: relative; flex: 1; min-width: 200px;">
                <input type="text" name="search" value="{{ search }}" 
                       placeholder="Search rooms..." 
                       style="width: 100%; padding: var(--spacing-sm) var(--spacing-md); background-color: var(--color-input-background); border: 1px solid var(--color-input-border); border-radius: var(--radius-md); color: var(--color-foreground); font-size: 0.875rem;">
            </div>
            
            <select name="room_type" style="padding: var(--spacing-sm) var(--spacing-md); background-color: var(--color-input-background); border: 1px solid var(--color-input-border); border-radius: var(--radius-md); color: var(--color-foreground); font-size: 0.875rem; min-width: 150px;">
                <option value="">All Types</option>
                {% for room_type in room_types %}
                <option value="{{ room_type.id }}" {% if room_type_filter == room_type.id|stringformat:"s" %}selected{% endif %}>{{ room_type.name }}</option>
                {% endfor %}
            </select>
            
            <select name="status" style="padding: var(--spacing-sm) var(--spacing-md); background-color: var(--color-input-background); border: 1px solid var(--color-input-border); border-radius: var(--radius-md); color: var(--color-foreground); font-size: 0.875rem; min-width: 150px;">
                <option value="">All Status</option>
                <option value="available" {% if status_filter == 'available' %}selected{% endif %}>Available</option>
                <option value="occupied" {% if status_filter == 'occupied' %}selected{% endif %}>Occupied</option>
                <option value="maintenance" {% if status_filter == 'maintenance' %}selected{% endif %}>Maintenance</option>
                <option value="cleaning" {% if status_filter == 'cleaning' %}selected{% endif %}>Cleaning</option>
                <option value="reserved" {% if status_filter == 'reserved' %}selected{% endif %}>Reserved</option>
            </select>
            
            <select name="floor" style="padding: var(--spacing-sm) var(--spacing-md); background-color: var(--color-input-background); border: 1px solid var(--color-input-border); border-radius: var(--radius-md); color: var(--color-foreground); font-size: 0.875rem; min-width: 150px;">
                <option value="">All Floors</option>
                <option value="1" {% if floor_filter == '1' %}selected{% endif %}>1st Floor</option>
                <option value="2" {% if floor_filter == '2' %}selected{% endif %}>2nd Floor</option>
                <option value="3" {% if floor_filter == '3' %}selected{% endif %}>3rd Floor</option>
                <option value="4" {% if floor_filter == '4' %}selected{% endif %}>4th Floor</option>
                <option value="5" {% if floor_filter == '5' %}selected{% endif %}>5th Floor</option>
            </select>
            
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i>
                Search
            </button>
        </form>
    </div>
</div>

<!-- Rooms Icons Grid -->
<style>
    .rooms-icons-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: var(--spacing-md); }
    .room-icon-tile { position: relative; text-align: center; overflow: visible; }
    .room-icon-link { display: flex; flex-direction: column; align-items: center; gap: 6px; text-decoration: none; }
    .room-icon { width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; box-shadow: var(--shadow-sm); transition: transform var(--transition-fast); }
    .room-icon i { font-size: 28px; }
    .room-icon-link:hover .room-icon { transform: translateY(-2px); }
    .room-number { font-size: 0.8rem; color: var(--color-foreground); }
    .room-card-popover { position: absolute; z-index: 2147483647; top: 76px; left: 50%; transform: translateX(-50%); width: 360px; max-width: 80vw; background: rgba(20,20,20,0.98); color: #ffffff; border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius-lg); box-shadow: 0 12px 30px rgba(0,0,0,0.45); padding: var(--spacing-md); display: none; pointer-events: auto; }
    .room-popover-backdrop { position: fixed; inset: 0; background: transparent; z-index: 2147483646; display: none; }
    @media (max-width: 480px) { .room-card-popover { left: 0; transform: none; } }
    .status-success { background-color: var(--color-success); }
    .status-danger { background-color: var(--color-danger); }
    .status-warning { background-color: var(--color-warning); color: var(--color-foreground); }
    .status-info { background-color: var(--color-info); }
    .status-primary { background-color: var(--color-primary); }
</style>

<div class="rooms-icons-grid">
    <div class="room-popover-backdrop" id="room-popover-backdrop"></div>
    {% for room in rooms %}
    <div class="room-icon-tile" data-room-id="{{ room.pk }}">
        <a class="room-icon-link" href="{% url 'room_detail' room.pk %}" data-hover-delay="1000">
            <div class="room-icon 
                {% if room.status == 'available' %}status-success{% elif room.status == 'occupied' %}status-danger
                {% elif room.status == 'maintenance' %}status-warning{% elif room.status == 'cleaning' %}status-info
                {% elif room.status == 'reserved' %}status-primary{% else %}status-info{% endif %}">
                <i class="fas fa-bed"></i>
            </div>
            <div class="room-number">Room {{ room.room_number }}</div>
        </a>

        <!-- Hover card (shows after 1s hover) -->
        <div class="room-card-popover">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-sm);">
                <div>
                    <h3 style="font-size: 1rem; font-weight: var(--font-weight-semibold); color: var(--color-foreground);">Room {{ room.room_number }}</h3>
                    <p style="color: var(--color-foreground-secondary); font-size: 0.75rem;">{{ room.room_type.name }} • {{ room.get_floor_display }}</p>
                </div>
                <span style="padding: 0.125rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.7rem; font-weight: var(--font-weight-medium);
                    {% if room.status == 'available' %}background-color: var(--color-success-light); color: var(--color-success);
                    {% elif room.status == 'occupied' %}background-color: var(--color-danger-light); color: var(--color-danger);
                    {% elif room.status == 'maintenance' %}background-color: var(--color-warning-light); color: var(--color-warning);
                    {% elif room.status == 'cleaning' %}background-color: var(--color-info-light); color: var(--color-info);
                    {% elif room.status == 'reserved' %}background-color: var(--color-primary-light); color: var(--color-primary);
                    {% else %}background-color: var(--color-background-tertiary); color: var(--color-foreground-secondary);{% endif %}">
                    {{ room.get_status_display }}
                </span>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                <div>
                    <div style="color: var(--color-foreground-secondary); font-size: 0.7rem;">Capacity</div>
                    <div style="color: var(--color-foreground); font-size: 0.8rem; font-weight: var(--font-weight-medium);">{{ room.room_type.capacity }} guests</div>
                </div>
                <div>
                    <div style="color: var(--color-foreground-secondary); font-size: 0.7rem;">Rate/Night</div>
                    <div style="color: var(--color-gold); font-size: 0.8rem; font-weight: var(--font-weight-semibold);">${{ room.effective_price }}</div>
                </div>
            </div>

            {% if room.current_guest %}
            <div style="color: var(--color-danger); font-size: 0.8rem; font-weight: var(--font-weight-medium); margin-bottom: var(--spacing-xs);">
                <i class="fas fa-user-check"></i> Occupied by {{ room.current_guest }}
            </div>
            {% else %}
            <div style="color: var(--color-success); font-size: 0.8rem; font-weight: var(--font-weight-medium); margin-bottom: var(--spacing-xs);">
                <i class="fas fa-check-circle"></i> Available now
            </div>
            {% endif %}

            <div style="display:flex; gap: var(--spacing-sm);">
                <a href="{% url 'room_detail' room.pk %}" class="btn btn-sm btn-primary">Open</a>
                <a href="{% url 'room_edit' room.pk %}" class="btn btn-sm btn-outline">Edit</a>
                <a href="{% url 'room_maintenance' room.pk %}" class="btn btn-sm btn-warning">Maintenance</a>
            </div>
        </div>
    </div>
    {% empty %}
    <div style="grid-column: 1 / -1;">
        <div class="card" style="text-align: center; padding: var(--spacing-2xl);">
            <i class="fas fa-bed" style="font-size: 4rem; color: var(--color-foreground-tertiary); margin-bottom: var(--spacing-lg);"></i>
            <h3 style="font-size: 1.5rem; font-weight: var(--font-weight-semibold); color: var(--color-foreground); margin-bottom: var(--spacing-md);">
                No rooms found
            </h3>
            <p style="color: var(--color-foreground-secondary); margin-bottom: var(--spacing-lg);">
                Get started by adding your first room.
            </p>
            <a href="{% url 'room_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Add Room
            </a>
        </div>
    </div>
    {% endfor %}
</div>

<script>
    (function() {
        var tiles = document.querySelectorAll('.room-icon-tile');
        var backdrop = document.getElementById('room-popover-backdrop');
        tiles.forEach(function(tile) {
            var link = tile.querySelector('.room-icon-link');
            var pop = tile.querySelector('.room-card-popover');
            var timerShow = null;
            var timerHide = null;
            var isPointerInside = false;
            var isOpen = false;
            function positionPopover() {
                if (!pop) return;
                var rect = link.getBoundingClientRect();
                pop.style.position = 'fixed';
                var top = rect.bottom + 12;
                var left = rect.left + rect.width / 2;
                pop.style.top = top + 'px';
                pop.style.left = left + 'px';
                pop.style.transform = 'translateX(-50%)';
            }
            function show() {
                if (!pop) return;
                positionPopover();
                pop.style.display = 'block';
                if (backdrop) { backdrop.style.display = 'block'; backdrop.style.pointerEvents = 'auto'; }
                isOpen = true;
            }
            function hide() {
                if (!pop) return;
                pop.style.display = 'none';
                if (backdrop) { backdrop.style.display = 'none'; backdrop.style.pointerEvents = 'none'; }
                isOpen = false;
            }
            function clearShow() { if (timerShow) { clearTimeout(timerShow); timerShow = null; } }
            function clearHide() { if (timerHide) { clearTimeout(timerHide); timerHide = null; } }
            function scheduleHide() {
                clearHide();
                timerHide = setTimeout(function(){ if (!isPointerInside) hide(); }, 500);
            }
            link.addEventListener('mouseenter', function() { isPointerInside = true; clearHide(); clearShow(); timerShow = setTimeout(show, 700); });
            link.addEventListener('mouseleave', function() { isPointerInside = false; clearShow(); scheduleHide(); });
            if (pop) {
                pop.addEventListener('mouseenter', function() { isPointerInside = true; clearHide(); });
                pop.addEventListener('mouseleave', function() { isPointerInside = false; scheduleHide(); });
            }
            window.addEventListener('scroll', function(){ if (pop && pop.style.display === 'block') positionPopover(); }, true);
            window.addEventListener('resize', function(){ if (pop && pop.style.display === 'block') positionPopover(); });
            if (backdrop) backdrop.addEventListener('click', function(){ isPointerInside = false; clearHide(); hide(); });
        });
    })();
    </script>

<!-- Legend for Status Colors -->
<div class="card" style="margin-top: var(--spacing-lg);">
    <h3 style="font-size: 1.125rem; font-weight: var(--font-weight-semibold); color: var(--color-foreground); margin-bottom: var(--spacing-md);">
        Status Legend
    </h3>
    <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-md);">
        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
            <div style="width: 16px; height: 16px; background-color: var(--color-success); border-radius: 3px;"></div>
            <span style="color: var(--color-foreground); font-size: 0.875rem;">Available</span>
        </div>
        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
            <div style="width: 16px; height: 16px; background-color: var(--color-danger); border-radius: 3px;"></div>
            <span style="color: var(--color-foreground); font-size: 0.875rem;">Occupied</span>
        </div>
        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
            <div style="width: 16px; height: 16px; background-color: var(--color-warning); border-radius: 3px;"></div>
            <span style="color: var(--color-foreground); font-size: 0.875rem;">Maintenance</span>
        </div>
        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
            <div style="width: 16px; height: 16px; background-color: var(--color-info); border-radius: 3px;"></div>
            <span style="color: var(--color-foreground); font-size: 0.875rem;">Cleaning</span>
        </div>
        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
            <div style="width: 16px; height: 16px; background-color: var(--color-primary); border-radius: 3px;"></div>
            <span style="color: var(--color-foreground); font-size: 0.875rem;">Reserved</span>
        </div>
    </div>
</div>
{% endblock %} 