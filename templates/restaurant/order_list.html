{% extends 'base.html' %}

{% block title %}Orders - Kabul Taj Hotel{% endblock %}

{% block content %}
<!-- Module Header -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
        <div>
            <h1 style="font-size: 2rem; font-weight: var(--font-weight-bold); color: var(--color-foreground); margin-bottom: var(--spacing-xs);">
                Restaurant Orders
            </h1>
            <p style="color: var(--color-foreground-secondary); font-size: 1rem;">
                Manage orders, track status, and process payments
            </p>
        </div>
        <div style="display: flex; gap: var(--spacing-md);">
            <button id="bulkActionsBtn" class="btn btn-outline" onclick="toggleBulkActions()" style="display: none;">
                <i class="fas fa-check-square"></i>
                <span id="bulkActionsText">Bulk Actions</span>
            </button>
            <button id="deleteSelectedBtn" class="btn btn-danger" onclick="deleteSelectedOrders()" style="display: none;">
                <i class="fas fa-trash"></i>
                Delete Selected
            </button>
            <a href="{% url 'restaurant:order_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                New Order
            </a>
        </div>
    </div>
</div>

<!-- Header Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon gold">
            <i class="fas fa-clipboard-list"></i>
        </div>
        <div class="stat-number">{{ total_orders }}</div>
        <div class="stat-label">Total Orders</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background-color: var(--color-warning); color: white;">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-number">{{ pending_orders }}</div>
        <div class="stat-label">Pending</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background-color: var(--color-success); color: white;">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-number">{{ completed_orders }}</div>
        <div class="stat-label">Completed</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background-color: var(--color-info); color: white;">
            <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-number">${{ total_revenue|floatformat:2 }}</div>
        <div class="stat-label">Revenue (Paid)</div>
    </div>
</div>

<!-- Search and Filters -->
<div class="card">
    <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
        <h3 style="font-size: 1.25rem; font-weight: var(--font-weight-semibold); color: var(--color-foreground);">
            Search & Filters
        </h3>
        
        <form method="get" style="display: flex; flex-wrap: wrap; gap: var(--spacing-md); align-items: center;">


            {% csrf_token %}
            <div style="position: relative; flex: 1; min-width: 200px;">
                <input type="text" name="search" value="{{ search }}" 
                       placeholder="Search orders..." 
                       style="width: 100%; padding: var(--spacing-sm) var(--spacing-md); background-color: var(--color-input-background); border: 1px solid var(--color-input-border); border-radius: var(--radius-md); color: var(--color-foreground); font-size: 0.875rem;">
            </div>
            
            <select name="status" style="padding: var(--spacing-sm) var(--spacing-md); background-color: var(--color-input-background); border: 1px solid var(--color-input-border); border-radius: var(--radius-md); color: var(--color-foreground); font-size: 0.875rem; min-width: 150px;">
                <option value="">All Status</option>
                {% for value, label in status_choices %}
                <option value="{{ value }}" {% if status == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            
            <select name="payment_status" style="padding: var(--spacing-sm) var(--spacing-md); background-color: var(--color-input-background); border: 1px solid var(--color-input-border); border-radius: var(--radius-md); color: var(--color-foreground); font-size: 0.875rem; min-width: 150px;">
                <option value="">All Payment Status</option>
                {% for value, label in payment_status_choices %}
                <option value="{{ value }}" {% if payment_status == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i>
                Search
            </button>
        </form>
    </div>
</div>

<!-- Orders Table -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
        <h3 style="font-size: 1.25rem; font-weight: var(--font-weight-semibold); color: var(--color-foreground);">
            All Orders
        </h3>
        <button id="enableBulkSelectBtn" class="btn btn-outline" onclick="enableBulkSelect()">
            <i class="fas fa-check-square"></i>
            Select Multiple
        </button>
    </div>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid var(--color-card-border);">
                    <th id="selectAllHeader" style="text-align: center; padding: var(--spacing-md); font-weight: var(--font-weight-semibold); color: var(--color-foreground); font-size: 0.875rem; display: none;">
                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                    </th>
                    <th style="text-align: left; padding: var(--spacing-md); font-weight: var(--font-weight-semibold); color: var(--color-foreground); font-size: 0.875rem;">Order</th>
                    <th style="text-align: left; padding: var(--spacing-md); font-weight: var(--font-weight-semibold); color: var(--color-foreground); font-size: 0.875rem;">Customer</th>
                    <th style="text-align: left; padding: var(--spacing-md); font-weight: var(--font-weight-semibold); color: var(--color-foreground); font-size: 0.875rem;">Table</th>
                    <th style="text-align: left; padding: var(--spacing-md); font-weight: var(--font-weight-semibold); color: var(--color-foreground); font-size: 0.875rem;">Amount</th>
                    <th style="text-align: left; padding: var(--spacing-md); font-weight: var(--font-weight-semibold); color: var(--color-foreground); font-size: 0.875rem;">Status</th>
                    <th style="text-align: left; padding: var(--spacing-md); font-weight: var(--font-weight-semibold); color: var(--color-foreground); font-size: 0.875rem;">Payment</th>
                    <th style="text-align: left; padding: var(--spacing-md); font-weight: var(--font-weight-semibold); color: var(--color-foreground); font-size: 0.875rem;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for order in page_obj %}
                <tr style="border-bottom: 1px solid var(--color-card-border); transition: all var(--transition-fast);">
                    <td class="order-checkbox" style="text-align: center; padding: var(--spacing-md); display: none;">
                        <input type="checkbox" class="order-select" value="{{ order.id }}" onchange="updateBulkActions()">
                    </td>
                    <td style="padding: var(--spacing-md);">
                        <div style="font-weight: var(--font-weight-medium); color: var(--color-foreground); font-size: 0.875rem;">
                            {{ order.order_number }}
                        </div>
                        <div style="color: var(--color-foreground-secondary); font-size: 0.75rem;">
                            {{ order.created_at|date:"M d, Y H:i" }}
                        </div>
                    </td>
                    <td style="padding: var(--spacing-md);">
                        <div style="font-weight: var(--font-weight-medium); color: var(--color-foreground); font-size: 0.875rem;">
                            {{ order.guest_name }}
                        </div>
                        <div style="color: var(--color-foreground-secondary); font-size: 0.75rem;">
                            {{ order.order_type }}
                        </div>
                        {% if order.guest %}
                        <div style="color: var(--color-info); font-size: 0.75rem;">
                            {{ order.guest.full_name }}
                        </div>
                        {% elif order.room %}
                        <div style="color: var(--color-success); font-size: 0.75rem;">
                            Room {{ order.room.room_number }}
                        </div>
                        {% endif %}
                    </td>
                    <td style="padding: var(--spacing-md);">
                        <div style="font-weight: var(--font-weight-medium); color: var(--color-foreground); font-size: 0.875rem;">
                            Table {{ order.table.table_number }}
                        </div>
                        <div style="color: var(--color-foreground-secondary); font-size: 0.75rem;">
                            {{ order.table.capacity }} seats
                        </div>
                    </td>
                    <td style="padding: var(--spacing-md);">
                        <div style="font-weight: var(--font-weight-semibold); color: var(--color-foreground); font-size: 0.875rem;">
                            ${{ order.total_amount }}
                        </div>
                    </td>
                    <td style="padding: var(--spacing-md);">
                        <select class="status-select" data-order-id="{{ order.id }}" style="padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: var(--font-weight-medium); border: none; cursor: pointer;
                            {% if order.status == 'placed' %}background-color: var(--color-info-light); color: var(--color-info);
                            {% elif order.status == 'preparing' %}background-color: var(--color-warning-light); color: var(--color-warning);
                            {% elif order.status == 'ready' %}background-color: var(--color-warning-light); color: var(--color-warning);
                            {% elif order.status == 'served' %}background-color: var(--color-success-light); color: var(--color-success);
                            {% elif order.status == 'billed' %}background-color: var(--color-gold-light); color: var(--color-gold);
                            {% else %}background-color: var(--color-foreground-tertiary); color: var(--color-foreground);{% endif %}">
                            {% for value, label in status_choices %}
                            <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td style="padding: var(--spacing-md);">
                        <span style="padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: var(--font-weight-medium);
                            {% if order.payment_status == 'paid' %}background-color: var(--color-success-light); color: var(--color-success);
                            {% elif order.payment_status == 'pending' %}background-color: var(--color-warning-light); color: var(--color-warning);
                            {% else %}background-color: var(--color-danger-light); color: var(--color-danger);{% endif %}">
                            {{ order.get_payment_status_display }}
                        </span>
                    </td>
                    <td style="padding: var(--spacing-md);">
                        <div style="display: flex; gap: var(--spacing-sm);">
                            <a href="{% url 'restaurant:order_detail' order.pk %}" style="color: var(--color-success); text-decoration: none; padding: var(--spacing-xs); border-radius: var(--radius-sm); transition: all var(--transition-fast);" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="#" style="color: var(--color-info); text-decoration: none; padding: var(--spacing-xs); border-radius: var(--radius-sm); transition: all var(--transition-fast);" title="Edit Order">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button onclick="printOrder('{{ order.order_number }}')" style="color: var(--color-gold); text-decoration: none; padding: var(--spacing-xs); border-radius: var(--radius-sm); transition: all var(--transition-fast); background: none; border: none; cursor: pointer;" title="Print Order">
                                <i class="fas fa-print"></i>
                            </button>
                            {% if order.status in 'cancelled,billed' %}
                            <a href="{% url 'restaurant:order_delete' order.pk %}" style="color: var(--color-danger); text-decoration: none; padding: var(--spacing-xs); border-radius: var(--radius-sm); transition: all var(--transition-fast);" title="Delete Order" onclick="return confirm('Are you sure you want to delete this order?')">
                                <i class="fas fa-trash"></i>
                            </a>
                            {% else %}
                            <span style="color: var(--color-foreground-tertiary); padding: var(--spacing-xs); border-radius: var(--radius-sm);" title="Cannot delete active orders">
                                <i class="fas fa-lock"></i>
                            </span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" style="padding: var(--spacing-xl); text-align: center; color: var(--color-foreground-secondary);">
                        No orders found. <a href="{% url 'restaurant:order_create' %}" style="color: var(--color-gold); text-decoration: none;">Create your first order</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div style="display: flex; justify-content: center; margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--color-card-border);">
        <nav style="display: flex; gap: var(--spacing-sm);">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if payment_status %}&payment_status={{ payment_status }}{% endif %}" 
               class="btn btn-outline">
                Previous
            </a>
            {% endif %}
            
            <span style="padding: var(--spacing-sm) var(--spacing-md); color: var(--color-foreground-secondary); font-size: 0.875rem; display: flex; align-items: center;">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </span>
            
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if payment_status %}&payment_status={{ payment_status }}{% endif %}" 
               class="btn btn-outline">
                Next
            </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>

<script>
// Status update functionality
document.querySelectorAll('.status-select').forEach(select => {
    select.addEventListener('change', function() {
        const orderId = this.dataset.orderId;
        const newStatus = this.value;
        
        fetch(`/restaurant/orders/${orderId}/update-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: `status=${newStatus}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the select styling based on new status
                this.className = `status-select`;
                this.style.backgroundColor = 
                    newStatus === 'placed' ? 'var(--color-info-light)' :
                    newStatus === 'preparing' ? 'var(--color-warning-light)' :
                    newStatus === 'ready' ? 'var(--color-warning-light)' :
                    newStatus === 'served' ? 'var(--color-success-light)' :
                    newStatus === 'billed' ? 'var(--color-gold-light)' :
                    'var(--color-foreground-tertiary)';
                this.style.color = 
                    newStatus === 'placed' ? 'var(--color-info)' :
                    newStatus === 'preparing' ? 'var(--color-warning)' :
                    newStatus === 'ready' ? 'var(--color-warning)' :
                    newStatus === 'served' ? 'var(--color-success)' :
                    newStatus === 'billed' ? 'var(--color-gold)' :
                    'var(--color-foreground)';
            } else {
                alert('Error updating order status');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating order status');
        });
    });
});

function printOrder(orderNumber) {
    // Open print window for order
    window.open(`/restaurant/orders/${orderNumber}/print/`, '_blank');
}

// Bulk selection functionality
let bulkSelectEnabled = false;

function enableBulkSelect() {
    bulkSelectEnabled = true;
    
    // Show checkboxes
    document.querySelectorAll('.order-checkbox').forEach(cell => {
        cell.style.display = 'table-cell';
    });
    document.getElementById('selectAllHeader').style.display = 'table-cell';
    
    // Show bulk action buttons
    document.getElementById('bulkActionsBtn').style.display = 'inline-flex';
    document.getElementById('enableBulkSelectBtn').style.display = 'none';
    
    // Update button text
    document.getElementById('bulkActionsText').textContent = 'Exit Selection';
}

function toggleBulkActions() {
    if (bulkSelectEnabled) {
        // Exit bulk select mode
        bulkSelectEnabled = false;
        
        // Hide checkboxes
        document.querySelectorAll('.order-checkbox').forEach(cell => {
            cell.style.display = 'none';
        });
        document.getElementById('selectAllHeader').style.display = 'none';
        
        // Hide bulk action buttons
        document.getElementById('bulkActionsBtn').style.display = 'none';
        document.getElementById('deleteSelectedBtn').style.display = 'none';
        document.getElementById('enableBulkSelectBtn').style.display = 'inline-flex';
        
        // Uncheck all checkboxes
        document.querySelectorAll('.order-select').forEach(checkbox => {
            checkbox.checked = false;
        });
        document.getElementById('selectAllCheckbox').checked = false;
    }
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const orderCheckboxes = document.querySelectorAll('.order-select');
    
    orderCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateBulkActions();
}

function updateBulkActions() {
    const selectedCheckboxes = document.querySelectorAll('.order-select:checked');
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    
    if (selectedCheckboxes.length > 0) {
        deleteBtn.style.display = 'inline-flex';
        deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Delete Selected (${selectedCheckboxes.length})`;
    } else {
        deleteBtn.style.display = 'none';
    }
    
    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.order-select');
    const checkedCheckboxes = document.querySelectorAll('.order-select:checked');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    if (checkedCheckboxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (checkedCheckboxes.length === allCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

function deleteSelectedOrders() {
    const selectedCheckboxes = document.querySelectorAll('.order-select:checked');
    
    if (selectedCheckboxes.length === 0) {
        alert('No orders selected for deletion.');
        return;
    }
    
    const orderIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);
    const orderNumbers = Array.from(selectedCheckboxes).map(checkbox => {
        const row = checkbox.closest('tr');
        return row.querySelector('td:nth-child(2) div:first-child').textContent.trim();
    });
    
    const confirmMessage = `Are you sure you want to delete the following orders?\n\n${orderNumbers.join('\n')}\n\nThis action cannot be undone.`;
    
    if (confirm(confirmMessage)) {
        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "restaurant:order_bulk_delete" %}';
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        }
        
        // Add order IDs
        orderIds.forEach(orderId => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'order_ids';
            input.value = orderId;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %} 