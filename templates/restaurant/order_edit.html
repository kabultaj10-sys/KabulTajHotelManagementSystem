{% extends 'base.html' %}

{% block title %}Edit Order {{ order.order_number }} - Kabul Taj Hotel{% endblock %}

{% block content %}
<!-- Module Header -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
        <div>
            <h1 style="font-size: 2rem; font-weight: var(--font-weight-bold); color: var(--color-foreground); margin-bottom: var(--spacing-xs);">
                Edit Order #{{ order.order_number }}
            </h1>
            <p style="color: var(--color-foreground-secondary); font-size: 1rem;">
                {{ order.created_at|date:"F d, Y at H:i" }} â€¢ {{ order.items.count }} items
            </p>
        </div>
        <div style="display: flex; gap: var(--spacing-md);">
            <a href="{% url 'restaurant:order_detail' order.pk %}" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i>
                Back to Order
            </a>
        </div>
    </div>
</div>

<div class="card">
    <form method="post" id="orderForm" style="display: flex; flex-direction: column; gap: var(--spacing-lg);">
        {% csrf_token %}
        
        <!-- Order Information -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-lg);">
            <!-- Table Selection -->
            <div>
                <label for="table" style="display: block; font-weight: var(--font-weight-medium); color: var(--color-foreground); margin-bottom: var(--spacing-sm);">
                    Table *
                </label>
                <select name="table" id="table" required style="width: 100%; padding: var(--spacing-sm) var(--spacing-md); background-color: var(--color-input-background); border: 1px solid var(--color-input-border); border-radius: var(--radius-md); color: var(--color-foreground); font-size: 0.875rem;">
                    <option value="">Select table</option>
                    {% for table in tables %}
                    <option value="{{ table.id }}" {% if table.id == order.table.id %}selected{% endif %}>Table {{ table.table_number }} ({{ table.capacity }} seats)</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Customer Name -->
            <div>
                <label for="guest_name" style="display: block; font-weight: var(--font-weight-medium); color: var(--color-foreground); margin-bottom: var(--spacing-sm);">
                    Customer Name
                </label>
                <input type="text" name="guest_name" id="guest_name" value="{{ order.guest_name }}" style="width: 100%; padding: var(--spacing-sm) var(--spacing-md); background-color: var(--color-input-background); border: 1px solid var(--color-input-border); border-radius: var(--radius-md); color: var(--color-foreground); font-size: 0.875rem;" placeholder="Enter customer name">
            </div>

            <!-- Customer Phone -->
            <div>
                <label for="guest_phone" style="display: block; font-weight: var(--font-weight-medium); color: var(--color-foreground); margin-bottom: var(--spacing-sm);">
                    Phone Number
                </label>
                <input type="text" name="guest_phone" id="guest_phone" value="{{ order.guest_phone }}" style="width: 100%; padding: var(--spacing-sm) var(--spacing-md); background-color: var(--color-input-background); border: 1px solid var(--color-input-border); border-radius: var(--radius-md); color: var(--color-foreground); font-size: 0.875rem;" placeholder="Enter phone number">
            </div>
        </div>

        <!-- Special Instructions -->
        <div>
            <label for="special_instructions" style="display: block; font-weight: var(--font-weight-medium); color: var(--color-foreground); margin-bottom: var(--spacing-sm);">
                Special Instructions
            </label>
            <textarea name="special_instructions" id="special_instructions" rows="3" style="width: 100%; padding: var(--spacing-sm) var(--spacing-md); background-color: var(--color-input-background); border: 1px solid var(--color-input-border); border-radius: var(--radius-md); color: var(--color-foreground); font-size: 0.875rem; resize: vertical;" placeholder="Any special instructions for the order">{{ order.special_instructions }}</textarea>
        </div>

        <!-- Menu Items Selection -->
        <div class="card" style="background-color: var(--color-background-secondary);">
            <h3 style="font-size: 1.25rem; font-weight: var(--font-weight-semibold); color: var(--color-foreground); margin-bottom: var(--spacing-lg);">
                Menu Items
            </h3>
            
            <!-- Category Filter -->
            <div style="margin-bottom: var(--spacing-lg);">
                <label for="category_filter" style="display: block; font-weight: var(--font-weight-medium); color: var(--color-foreground); margin-bottom: var(--spacing-sm);">
                    Filter by Category
                </label>
                <select name="category_filter" id="category_filter" style="width: 100%; max-width: 300px; padding: var(--spacing-sm) var(--spacing-md); background-color: var(--color-input-background); border: 1px solid var(--color-input-border); border-radius: var(--radius-md); color: var(--color-foreground); font-size: 0.875rem;">
                    <option value="">All Categories</option>
                    {% for category in menu_items|slice:":1" %}
                    <option value="{{ category.category.id }}">{{ category.category.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Menu Items Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                {% for item in menu_items %}
                <div class="menu-item" data-item-id="{{ item.id }}" data-item-name="{{ item.name }}" data-item-price="{{ item.price }}" data-item-category="{{ item.category.id }}" style="padding: var(--spacing-md); background-color: var(--color-card); border: 1px solid var(--color-card-border); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast);">
                    <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                        <div style="width: 3rem; height: 3rem; background-color: var(--color-background-tertiary); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-utensils" style="color: var(--color-foreground-tertiary);"></i>
                        </div>
                        <div style="flex: 1;">
                            <h4 style="font-weight: var(--font-weight-medium); color: var(--color-foreground); font-size: 0.875rem; margin-bottom: var(--spacing-xs);">
                                {{ item.name }}
                            </h4>
                            <p style="color: var(--color-foreground-secondary); font-size: 0.75rem; margin-bottom: var(--spacing-xs);">
                                {{ item.category.name }}
                            </p>
                            <p style="font-weight: var(--font-weight-semibold); color: var(--color-gold); font-size: 0.875rem;">
                                ${{ item.price|floatformat:2 }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Selected Items -->
            <div>
                <h4 style="font-weight: var(--font-weight-medium); color: var(--color-foreground); margin-bottom: var(--spacing-md);">
                    Selected Items
                </h4>
                <div id="selectedItems" style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                    <!-- Selected items will be added here dynamically -->
                </div>
                <input type="hidden" name="items" id="itemsData" value="[]">
            </div>
        </div>

        <!-- Order Summary -->
        <div class="card" style="background-color: var(--color-background-secondary);">
            <h4 style="font-weight: var(--font-weight-medium); color: var(--color-foreground); margin-bottom: var(--spacing-md);">
                Order Summary
            </h4>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--color-foreground-secondary); font-size: 0.875rem;">Total Items:</span>
                <span id="totalItems" style="font-weight: var(--font-weight-semibold); color: var(--color-foreground);">0</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--spacing-sm);">
                <span style="color: var(--color-foreground-secondary); font-size: 0.875rem;">Total Amount:</span>
                <span id="totalAmount" style="font-size: 1.5rem; font-weight: var(--font-weight-bold); color: var(--color-gold);">$0.00</span>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div style="display: flex; justify-content: end; gap: var(--spacing-md);">
            <a href="{% url 'restaurant:order_detail' order.pk %}" class="btn btn-outline">
                Cancel
            </a>
            <button type="submit" class="btn btn-primary">
                Save Changes
            </button>
        </div>
    </form>
</div>

<script>
let selectedItems = [];

// Initialize with existing order items
document.addEventListener('DOMContentLoaded', function() {
    // Load existing order items
    {% for item in order.items.all %}
    selectedItems.push({
        menu_item_id: {{ item.menu_item.id }},
        name: "{{ item.menu_item.name|escapejs }}",
        price: {{ item.unit_price }},
        quantity: {{ item.quantity }},
        special_instructions: "{{ item.special_instructions|escapejs }}"
    });
    {% endfor %}
    
    updateSelectedItemsDisplay();
});

// Menu item click handler
document.querySelectorAll('.menu-item').forEach(item => {
    item.addEventListener('click', function() {
        const itemId = this.dataset.itemId;
        const itemName = this.dataset.itemName;
        const itemPrice = parseFloat(this.dataset.itemPrice);
        
        // Check if item is already selected
        const existingItem = selectedItems.find(item => item.menu_item_id === itemId);
        
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            selectedItems.push({
                menu_item_id: itemId,
                name: itemName,
                price: itemPrice,
                quantity: 1,
                special_instructions: ''
            });
        }
        
        updateSelectedItemsDisplay();
    });
});

// Category filter
document.getElementById('category_filter').addEventListener('change', function() {
    const categoryId = this.value;
    const menuItems = document.querySelectorAll('.menu-item');
    
    menuItems.forEach(item => {
        if (!categoryId || item.dataset.itemCategory === categoryId) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
});

function updateSelectedItemsDisplay() {
    const container = document.getElementById('selectedItems');
    const itemsData = document.getElementById('itemsData');
    const totalItemsSpan = document.getElementById('totalItems');
    const totalAmountSpan = document.getElementById('totalAmount');
    
    container.innerHTML = '';
    let totalItems = 0;
    let totalAmount = 0;
    
    selectedItems.forEach((item, index) => {
        totalItems += item.quantity;
        totalAmount += item.quantity * item.price;
        
        const itemDiv = document.createElement('div');
        itemDiv.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-md); background-color: var(--color-card); border-radius: var(--radius-md); border: 1px solid var(--color-card-border);';
        itemDiv.innerHTML = `
            <div style="flex: 1;">
                <h6 style="font-weight: var(--font-weight-medium); color: var(--color-foreground); font-size: 0.875rem; margin-bottom: var(--spacing-xs);">${item.name}</h6>
                <p style="color: var(--color-foreground-secondary); font-size: 0.75rem;">$${item.price.toFixed(2)} each</p>
                ${item.special_instructions ? `<p style="color: var(--color-info); font-size: 0.75rem; margin-top: var(--spacing-xs);"><i class="fas fa-info-circle"></i> ${item.special_instructions}</p>` : ''}
            </div>
            <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                <button type="button" onclick="updateQuantity(${index}, -1)" style="padding: 0.25rem 0.5rem; background-color: var(--color-background-tertiary); border: none; border-radius: var(--radius-sm); color: var(--color-foreground); cursor: pointer;">-</button>
                <span style="font-weight: var(--font-weight-medium); color: var(--color-foreground); font-size: 0.875rem;">${item.quantity}</span>
                <button type="button" onclick="updateQuantity(${index}, 1)" style="padding: 0.25rem 0.5rem; background-color: var(--color-background-tertiary); border: none; border-radius: var(--radius-sm); color: var(--color-foreground); cursor: pointer;">+</button>
                <button type="button" onclick="removeItem(${index})" style="padding: 0.25rem 0.5rem; background-color: var(--color-danger-light); border: none; border-radius: var(--radius-sm); color: var(--color-danger); cursor: pointer;">Ã—</button>
            </div>
        `;
        container.appendChild(itemDiv);
    });
    
    totalItemsSpan.textContent = totalItems;
    totalAmountSpan.textContent = `$${totalAmount.toFixed(2)}`;
    itemsData.value = JSON.stringify(selectedItems);
}

function updateQuantity(index, change) {
    selectedItems[index].quantity += change;
    if (selectedItems[index].quantity <= 0) {
        selectedItems.splice(index, 1);
    }
    updateSelectedItemsDisplay();
}

function removeItem(index) {
    selectedItems.splice(index, 1);
    updateSelectedItemsDisplay();
}

// Form submission
document.getElementById('orderForm').addEventListener('submit', function(e) {
    if (selectedItems.length === 0) {
        e.preventDefault();
        alert('Please select at least one menu item.');
        return;
    }
});
</script>
{% endblock %}
